/*!
 *	HMT Bus GO -- 华农校巴查询程序
 *
 *	@author CRH380A-2722 <609657831@qq.com>
 *	@copyright 2016-2017 CRH380A-2722
 *	@license MIT
 *	@note 通用JavaScript
 */
(function(e){var z="";var u="";var v="";var h=0;var g=0;var j=0;var t,A,p;var B;var m=null;var l=busOffline=[];var y;var q;function c(){e("#stopName").autocomplete({source:"./ajax/ajax.StopName.php"});NProgress.configure({showSpinner:false,parent:"#progress-embeded"});e("#device-refresh-btn").on("click",function(){e("#device-refresh-btn").html("刷新中...");e("#device-refresh-btn").addClass("disabled");e("#loader").fadeIn("fast");NProgress.start();x()});e("#device-auto-refresh-btn").on("click",function(){autoRefreshDevice()});e("#stop-refresh-btn").on("click",function(){B=e("#line-id").val();e("#stop-refresh-btn").html("刷新中...");e("#stop-refresh-btn").addClass("disabled");e("#loader").fadeIn("fast");NProgress.start();w()});e("#stop-auto-refresh-btn").on("click",function(){o()});e("#toggle-timetable-weekday").on("click",function(){j=0;e("#timetable-weekend").fadeOut("fast");if(g){e("#toggle-timetable-weekday").html('<span class="fa fa-expand"></span> 展开工作日时刻表');e("#timetable-weekday").fadeOut("fast");g=0}else{e("#toggle-timetable-weekday").html('<span class="fa fa-compress"></span> 收起工作日时刻表');e("#timetable-weekday").fadeIn("fast");g=1}});e("#toggle-timetable-weekend").on("click",function(){g=0;e("#timetable-weekday").fadeOut("fast");if(j){e("#toggle-timetable-weekend").html('<span class="fa fa-expand"></span> 展开周末节假日时刻表');e("#timetable-weekend").fadeOut("fast");j=0}else{e("#toggle-timetable-weekend").html('<span class="fa fa-compress"></span> 收起周末节假日时刻表');e("#timetable-weekend").fadeIn("fast");j=1}});e("#toggle-wxss-qrcode").on("click",function(){e("#wxss-qrcode").modal("show")});if(document.getElementById("busmap")){y=new AMap.Map("busmap",{resizeEnable:true,zoom:15,center:[113.359423,23.157328]});AMap.plugin(["AMap.Scale"],function(){var C=new AMap.Scale();y.addControl(C)});AMap.plugin("AMap.Geolocation",function(){var C=new AMap.Geolocation({enableHighAccuracy:true,timeout:60000,buttonOffset:new AMap.Pixel(10,20),zoomToAccuracy:true,buttonPosition:"RB",markerOptions:{icon:"./source/img/map-marker/marker-you.png",offset:new AMap.Pixel(-18,-18)}});y.addControl(C);C.getCurrentPosition()});r();f();x();p=setInterval(function(){f();x()},cacheTimeout);e('a[class="list-group-item get-polyline-link"]').on("click",function(D){var C=D.currentTarget.id;n(C)})}}function x(){var C;z="";u="";m=e.get("./ajax/ajax.GetDevice.php",function(D){for(a=0;a<D["ONLINE"].length;a++){z+='<div class="col-sm-4"><div class="panel panel-success"><div class="panel-heading"><h3 class="panel-title"><span class="fa fa-bus"></span> '+D["ONLINE"][a]["BUS_NUM"]+'</h3></div><ul class="list-group"><li class="list-group-item"><strong>终端状态:</strong> <span class="text-success">在线</span></li><li class="list-group-item"><strong>执行线路:</strong> '+D["ONLINE"][a]["LINE_NAME"]+'</li><li class="list-group-item"><strong>当前站:</strong> '+D["ONLINE"][a]["CURRENT_STOP_NAME"]+'</li><li class="list-group-item"><strong>下一站:</strong> '+D["ONLINE"][a]["NEXT_STOP_NAME"]+'</li><li class="list-group-item"><strong>GPS最后更新时间:</strong> '+D["ONLINE"][a]["UPDATE_TIME"]+"</li></ul></div></div>"}for(b=0;b<D["OFFLINE"].length;b++){u+='<div class="col-sm-4"><div class="panel panel-danger"><div class="panel-heading"><h3 class="panel-title"><span class="fa fa-bus"></span> '+D["OFFLINE"][b]["BUS_NUM"]+'</h3></div><ul class="list-group"><li class="list-group-item"><strong>终端状态:</strong> <span class="text-danger">离线</span></li><li class="list-group-item"><strong>GPS最后更新时间:</strong> '+D["OFFLINE"][b]["UPDATE_TIME"]+"</li></ul></div></div>"}e("#online-list").html(z);e("#offline-list").html(u);NProgress.done();m=null;clearTimeout(C)});C=setTimeout(function(){if(m){m.abort();m=null;x()}},4000)}function w(){var C;v="";m=e.post("./ajax/ajax.GetStop.php",{lineId:B},function(D){for(i=0;i<D.length;i++){v+='<a href="./index.php?mod=stopinfo&id='+D[i]["stop_id"]+'" class="list-group-item">';if(D[i]["have_bus"]){v+='<span class="badge"><span class="fa fa-bus"></span> '+D[i]["have_bus"]+"</span>"}v+='<span class="fa fa-map-marker"></span> '+D[i]["stop_name"]+"</a>"}e("#stop-list").html(v);e("#stop-refresh-btn").html('<span class="fa fa-refresh"></span> 刷新数据');e("#stop-refresh-btn").removeClass("disabled");e("#loader").fadeOut("fast");NProgress.done();m=null;clearTimeout(C)});C=setTimeout(function(){if(m){m.abort();m=null;e("#timeout").modal("show");e("#stop-refresh-btn").html('<span class="fa fa-refresh"></span> 刷新数据');e("#stop-refresh-btn").removeClass("disabled");e("#loader").fadeOut("fast");NProgress.done();e("#status").html("OFF");e("#auto-refresh-logo").removeClass("fa-spin");h=0;clearInterval(t);e("#auto-refresh-flag").prop("checked",false);e("#stop-auto-refresh-btn").removeClass("active")}},10000)}function o(){setTimeout(function(){if(e("#auto-refresh-flag").prop("checked")){e("#status").html("ON");e("#auto-refresh-logo").addClass("fa-spin");h=1}else{e("#status").html("OFF");e("#auto-refresh-logo").removeClass("fa-spin");h=0}if(h){t=setInterval(function(){e("#stop-refresh-btn").addClass("disabled");e("#stop-refresh-btn").html("刷新中...");e("#loader").fadeIn("fast");NProgress.start();w()},cacheTimeout)}else{clearInterval(t)}},5)}function f(){var C;var D=e.get("./ajax/ajax.GetBusLocation.php",function(G){y.remove(l);y.remove(busOffline);var F=G.online;var E=G.offline;for(i=0;i<F.length;i++){onlineMarker=new AMap.Marker({icon:"./source/img/map-marker/marker-bus-online.png",position:F[i].position,offset:new AMap.Pixel(-18,-18),extData:{busNum:F[i].busNum,line:F[i].line,currentStop:F[i].currentStop,nextStop:F[i].nextStop,lastUpdate:F[i].lastUpdate}});onlineMarker.setMap(y);l.push(onlineMarker);AMap.event.addListener(onlineMarker,"click",function(J){var I=J.target.G.extData;var K='<span class="fa fa-bus"></span> '+I.busNum;var H='<ul class="list-group">';H+='<li class="list-group-item"><strong>终端状态:</strong> <span class="text-success">在线</span></li>';H+='<li class="list-group-item"><strong>执行线路:</strong> '+I.line+"</li>";H+='<li class="list-group-item"><strong>当前站:</strong> '+I.currentStop+"</li>";H+='<li class="list-group-item"><strong>下一站:</strong> '+I.nextStop+"</li>";H+='<li class="list-group-item"><strong>GPS最后更新时间:</strong> '+I.lastUpdate+"</li>";H+="</ul>";d(K,H)})}for(k=0;k<E.length;k++){offlineMarker=new AMap.Marker({icon:"./source/img/map-marker/marker-bus-offline.png",position:E[k].position,offset:new AMap.Pixel(-18,-18),extData:{busNum:E[k].busNum,lastUpdate:E[k].lastUpdate}});offlineMarker.setMap(y);busOffline.push(offlineMarker);AMap.event.addListener(offlineMarker,"click",function(J){var I=J.target.G.extData;var K='<span class="fa fa-bus"></span> '+I.busNum;var H='<ul class="list-group">';H+='<li class="list-group-item"><strong>终端状态:</strong> <span class="text-danger">离线</span></li>';H+='<li class="list-group-item"><strong>GPS最后更新时间:</strong> '+I.lastUpdate+"</li>";H+="</ul>";d(K,H)})}D=null;clearTimeout(C)});C=setTimeout(function(){if(D){D.abort();D=null;f()}},4000)}function r(){var C;var D=e.get("./ajax/ajax.GetStopLocation.php",function(E){for(i=0;i<E.length;i++){marker=new AMap.Marker({icon:"./source/img/map-marker/marker-stop.png",position:E[i].position,offset:new AMap.Pixel(-18,-18),extData:{stopId:E[i].stopId}});marker.setMap(y);AMap.event.addListener(marker,"click",function(G){var F=G.target.G.extData.stopId;s(F)})}D=null;clearTimeout(C)});C=setTimeout(function(){if(D){D.abort();D=null;r()}},4000)}function n(C){if(q){q.setMap(null)}var D;var E=e.post("./ajax/ajax.GetPolyline.php",{id:C},function(F){q=new AMap.Polyline({path:F[0].poly_path,strokeColor:F[0].poly_color,strokeOpacity:0.8,strokeWeight:5,strokeStyle:"soild",strokeDasharray:[10,5]});q.setMap(y);E=null;clearTimeout(D)});D=setTimeout(function(){if(E){E.abort();E=null;n(C)}},4000)}function d(D,C){e("#marker-title").html(D);e("#marker-content").html(C);e("#marker-detail").modal("show")}function s(C){var D;NProgress.start();e("#loader").fadeIn("fast");var E=e.post("./ajax/ajax.GetStopDetail.php",{id:C},function(H){var F=H.stop[0];var J=H.lineList;var I='<span class="fa fa-map-marker"></span> '+F.stop_name;var G='<div class="alert alert-info">有 <strong>'+J.length+"</strong> 条线路经过此站</div>";G+='<div class="list-group">';for(i=0;i<J.length;i++){G+='<a data-pjax="no-pjax" href="./index.php?mod=lineinfo&id='+J[i].line_id+'" class="list-group-item"><span class="fa fa-bus"></span> '+J[i].line_name+" [ "+J[i].line_start+" 开往 "+J[i].line_end+" ]</a>"}G+="</div>";d(I,G);e("#loader").fadeOut("fast");NProgress.done();E=null;clearTimeout(D)});D=setTimeout(function(){if(E){E.abort();e("#timeout").modal("show");e("#loader").fadeOut("fast");NProgress.done();E=null}},10000)}e(document).ready(function(){c();e(document).pjax('a[data-pjax!="no-pjax"]',"#pjax",{fragment:"#pjax",timeout:60000});e(document).on("submit","#stopSearch",function(C){e.pjax.submit(C,"#pjax",{fragment:"#pjax",timeout:60000})});e(document).on("pjax:send",function(){clearInterval(A);clearInterval(t);clearInterval(p);m=null;e("#loader").fadeIn("fast");e("#navbar-collapse").collapse({toggle:false});e("#navbar-collapse").collapse("hide");NProgress.start()});e(document).on("pjax:complete",function(){e("body,html").animate({scrollTop:0},0);e("#loader").fadeOut("fast");NProgress.done();c()})})})(jQuery);