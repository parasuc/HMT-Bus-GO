/*!
 *	HMT Bus GO -- 华农校巴查询程序
 *
 *	@author CRH380A-2722 <609657831@qq.com>
 *	@copyright 2016-2017 CRH380A-2722
 *	@license MIT
 *	@note 通用JavaScript
 */
(function(d){var w="";var s="";var t="";var g="";var j=0;var h=0;var l=0;var r,x,p;var y;var n=null;var m=busOffline=[];function c(){d("#stopName").autocomplete({source:"./ajax/ajax.StopName.php"});NProgress.configure({showSpinner:false,parent:"#progress-embeded"});d("#device-refresh-btn").on("click",function(){d("#device-refresh-btn").html("刷新中...");d("#device-refresh-btn").addClass("disabled");d("#loader").fadeIn("fast");NProgress.start();v()});d("#device-auto-refresh-btn").on("click",function(){autoRefreshDevice()});d("#stop-refresh-btn").on("click",function(){y=d("#line-id").val();d("#stop-refresh-btn").html("刷新中...");d("#stop-refresh-btn").addClass("disabled");d("#loader").fadeIn("fast");NProgress.start();u()});d("#stop-auto-refresh-btn").on("click",function(){o()});d("#toggle-timetable-weekday").on("click",function(){l=0;d("#timetable-weekend").fadeOut("fast");if(h){d("#toggle-timetable-weekday").html('<span class="fa fa-expand"></span> 展开工作日时刻表');d("#timetable-weekday").fadeOut("fast");h=0}else{d("#toggle-timetable-weekday").html('<span class="fa fa-compress"></span> 收起工作日时刻表');d("#timetable-weekday").fadeIn("fast");h=1}});d("#toggle-timetable-weekend").on("click",function(){h=0;d("#timetable-weekday").fadeOut("fast");if(l){d("#toggle-timetable-weekend").html('<span class="fa fa-expand"></span> 展开周末节假日时刻表');d("#timetable-weekend").fadeOut("fast");l=0}else{d("#toggle-timetable-weekend").html('<span class="fa fa-compress"></span> 收起周末节假日时刻表');d("#timetable-weekend").fadeIn("fast");l=1}});d("#toggle-wxss-qrcode").on("click",function(){d("#wxss-qrcode").modal("show")});if(document.getElementById("busmap")){var z=new AMap.Map("busmap",{resizeEnable:true,zoom:16,center:[113.354573,23.155394]});AMap.plugin(["AMap.Scale"],function(){var A=new AMap.Scale();z.addControl(A)});q(z);e(z);v();p=setInterval(function(){e(z);v()},15000)}}function v(){w="";s="";n=d.get("./ajax/ajax.GetDevice.php",function(z){for(a=0;a<z["ONLINE"].length;a++){w+='<div class="col-sm-4"><div class="panel panel-success"><div class="panel-heading"><h3 class="panel-title"><span class="fa fa-bus"></span> '+z["ONLINE"][a]["BUS_NUM"]+'</h3></div><ul class="list-group"><li class="list-group-item"><strong>终端状态:</strong> <span class="text-success">在线</span></li><li class="list-group-item"><strong>执行线路:</strong> '+z["ONLINE"][a]["LINE_NAME"]+'</li><li class="list-group-item"><strong>当前站:</strong> '+z["ONLINE"][a]["CURRENT_STOP_NAME"]+'</li><li class="list-group-item"><strong>下一站:</strong> '+z["ONLINE"][a]["NEXT_STOP_NAME"]+'</li><li class="list-group-item"><strong>GPS最后更新时间:</strong> '+z["ONLINE"][a]["UPDATE_TIME"]+"</li></ul></div></div>"}for(b=0;b<z["OFFLINE"].length;b++){s+='<div class="col-sm-4"><div class="panel panel-danger"><div class="panel-heading"><h3 class="panel-title"><span class="fa fa-bus"></span> '+z["OFFLINE"][b]["BUS_NUM"]+'</h3></div><ul class="list-group"><li class="list-group-item"><strong>终端状态:</strong> <span class="text-danger">离线</span></li><li class="list-group-item"><strong>GPS最后更新时间:</strong> '+z["OFFLINE"][b]["UPDATE_TIME"]+"</li></ul></div></div>"}d("#online-list").html(w);d("#offline-list").html(s);NProgress.done();n=null});setTimeout(function(){if(n){n.abort();n=null;v()}},10000)}function u(){t="";n=d.post("./ajax/ajax.GetStop.php",{lineId:y},function(z){for(i=0;i<z.length;i++){t+='<a href="./index.php?mod=stopinfo&id='+z[i]["stop_id"]+'" class="list-group-item">';if(z[i]["have_bus"]){t+='<span class="badge"><span class="fa fa-bus"></span> '+z[i]["have_bus"]+"</span>"}t+='<span class="fa fa-map-marker"></span> '+z[i]["stop_name"]+"</a>"}d("#stop-list").html(t);d("#stop-refresh-btn").html('<span class="fa fa-refresh"></span> 刷新数据');d("#stop-refresh-btn").removeClass("disabled");d("#loader").fadeOut("fast");NProgress.done();n=null});setTimeout(function(){if(n){n.abort();n=null;d("#timeout").modal("show");d("#stop-refresh-btn").html('<span class="fa fa-refresh"></span> 刷新数据');d("#stop-refresh-btn").removeClass("disabled");d("#loader").fadeOut("fast");NProgress.done();d("#status").html("OFF");d("#auto-refresh-logo").removeClass("fa-spin");j=0;clearInterval(r);d("#auto-refresh-flag").prop("checked",false);d("#stop-auto-refresh-btn").removeClass("active")}},10000)}function o(){setTimeout(function(){if(d("#auto-refresh-flag").prop("checked")){d("#status").html("ON");d("#auto-refresh-logo").addClass("fa-spin");j=1}else{d("#status").html("OFF");d("#auto-refresh-logo").removeClass("fa-spin");j=0}if(j){r=setInterval(function(){d("#stop-refresh-btn").addClass("disabled");d("#stop-refresh-btn").html("刷新中...");d("#loader").fadeIn("fast");NProgress.start();u()},15000)}else{clearInterval(r)}},5)}function e(z){var A=d.get("./ajax/ajax.GetBusLocation.php",function(D){z.remove(m);z.remove(busOffline);var C=D.online;var B=D.offline;for(i=0;i<C.length;i++){marker=new AMap.Marker({icon:"./source/img/map-marker/marker-bus-online.png",position:C[i].position,title:C[i].title+"（终端在线）"});marker.setMap(z);m.push(marker)}for(k=0;k<B.length;k++){marker=new AMap.Marker({icon:"./source/img/map-marker/marker-bus-offline.png",position:B[k].position,title:B[k].title+"（终端离线）"});marker.setMap(z);busOffline.push(marker)}A=null});setTimeout(function(){if(A){A.abort();A=null;e(z)}},10000)}function q(z){var A=d.get("./ajax/ajax.GetStopLocation.php",function(B){for(i=0;i<B.length;i++){marker=new AMap.Marker({icon:"./source/img/map-marker/marker-stop.png",position:B[i].position,title:B[i].title});marker.setMap(z)}A=null});setTimeout(function(){if(A){A.abort();A=null;q()}},10000)}function f(B){var z=[[113.346806,23.158857],[113.34614,23.158975],[113.347085,23.158482],[113.347278,23.158482],[113.347557,23.158403],[113.347578,23.158383],[113.348072,23.158995],[113.348683,23.158975],[113.349617,23.158798],[113.35011,23.15866],[113.352599,23.15861],[113.352599,23.159271],[113.352717,23.159202],[113.35306,23.159163],[113.353318,23.159182],[113.353618,23.159232],[113.354123,23.159182],[113.354112,23.159172],[113.354466,23.157683],[113.35453,23.154783],[113.354638,23.154694],[113.357062,23.154674],[113.357127,23.153086],[113.366225,23.153086],[113.366439,23.153106],[113.366439,23.151439],[113.366783,23.151675],[113.369701,23.151715],[113.369744,23.153106],[113.372008,23.154013],[113.372093,23.154615],[113.371418,23.155256],[113.370087,23.156854],[113.369411,23.157426],[113.368328,23.158018],[113.368338,23.160524]];var A=new AMap.Polyline({path:z,strokeColor:"#0099ff",strokeOpacity:0.8,strokeWeight:5,strokeStyle:"soild",strokeDasharray:[10,5]});A.setMap(B)}d(document).ready(function(){c();d(document).pjax('a[data-pjax!="no-pjax"]',"#pjax",{fragment:"#pjax",timeout:60000});d(document).on("submit","#stopSearch",function(z){d.pjax.submit(z,"#pjax",{fragment:"#pjax",timeout:60000})});d(document).on("pjax:send",function(){clearInterval(x);clearInterval(r);clearInterval(p);n=null;d("#loader").fadeIn("fast");d("#navbar-collapse").collapse({toggle:false});d("#navbar-collapse").collapse("hide");NProgress.start()});d(document).on("pjax:complete",function(){d("body,html").animate({scrollTop:0},0);d("#loader").fadeOut("fast");NProgress.done();c()})})})(jQuery);