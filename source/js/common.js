/*!
 *	HMT Bus GO -- 华农校巴查询程序
 *
 *	@author CRH380A-2722 <609657831@qq.com>
 *	@copyright 2016-2017 CRH380A-2722
 *	@license MIT
 *	@note 通用JavaScript
 */
(function(d){var x="";var s="";var t="";var g=0;var f=0;var h=0;var r,y,o;var z;var l=null;var j=busOffline=[];var w;var p;function c(){d("#stopName").autocomplete({source:"./ajax/ajax.StopName.php"});NProgress.configure({showSpinner:false,parent:"#progress-embeded"});d("#device-refresh-btn").on("click",function(){d("#device-refresh-btn").html("刷新中...");d("#device-refresh-btn").addClass("disabled");d("#loader").fadeIn("fast");NProgress.start();v()});d("#device-auto-refresh-btn").on("click",function(){autoRefreshDevice()});d("#stop-refresh-btn").on("click",function(){z=d("#line-id").val();d("#stop-refresh-btn").html("刷新中...");d("#stop-refresh-btn").addClass("disabled");d("#loader").fadeIn("fast");NProgress.start();u()});d("#stop-auto-refresh-btn").on("click",function(){n()});d("#toggle-timetable-weekday").on("click",function(){h=0;d("#timetable-weekend").fadeOut("fast");if(f){d("#toggle-timetable-weekday").html('<span class="fa fa-expand"></span> 展开工作日时刻表');d("#timetable-weekday").fadeOut("fast");f=0}else{d("#toggle-timetable-weekday").html('<span class="fa fa-compress"></span> 收起工作日时刻表');d("#timetable-weekday").fadeIn("fast");f=1}});d("#toggle-timetable-weekend").on("click",function(){f=0;d("#timetable-weekday").fadeOut("fast");if(h){d("#toggle-timetable-weekend").html('<span class="fa fa-expand"></span> 展开周末节假日时刻表');d("#timetable-weekend").fadeOut("fast");h=0}else{d("#toggle-timetable-weekend").html('<span class="fa fa-compress"></span> 收起周末节假日时刻表');d("#timetable-weekend").fadeIn("fast");h=1}});d("#toggle-wxss-qrcode").on("click",function(){d("#wxss-qrcode").modal("show")});if(document.getElementById("busmap")){w=new AMap.Map("busmap",{resizeEnable:true,zoom:16,center:[113.354573,23.155394]});AMap.plugin(["AMap.Scale"],function(){var A=new AMap.Scale();w.addControl(A)});AMap.plugin("AMap.Geolocation",function(){var A=new AMap.Geolocation({enableHighAccuracy:true,timeout:60000,buttonOffset:new AMap.Pixel(10,20),zoomToAccuracy:true,buttonPosition:"RB",markerOptions:{icon:"./source/img/map-marker/marker-you.png"}});w.addControl(A);A.getCurrentPosition()});q();e();v();o=setInterval(function(){e();v()},cacheTimeout);d('a[class="list-group-item get-polyline-link"]').on("click",function(B){var A=B.currentTarget.id;m(A)})}}function v(){x="";s="";l=d.get("./ajax/ajax.GetDevice.php",function(A){for(a=0;a<A["ONLINE"].length;a++){x+='<div class="col-sm-4"><div class="panel panel-success"><div class="panel-heading"><h3 class="panel-title"><span class="fa fa-bus"></span> '+A["ONLINE"][a]["BUS_NUM"]+'</h3></div><ul class="list-group"><li class="list-group-item"><strong>终端状态:</strong> <span class="text-success">在线</span></li><li class="list-group-item"><strong>执行线路:</strong> '+A["ONLINE"][a]["LINE_NAME"]+'</li><li class="list-group-item"><strong>当前站:</strong> '+A["ONLINE"][a]["CURRENT_STOP_NAME"]+'</li><li class="list-group-item"><strong>下一站:</strong> '+A["ONLINE"][a]["NEXT_STOP_NAME"]+'</li><li class="list-group-item"><strong>GPS最后更新时间:</strong> '+A["ONLINE"][a]["UPDATE_TIME"]+"</li></ul></div></div>"}for(b=0;b<A["OFFLINE"].length;b++){s+='<div class="col-sm-4"><div class="panel panel-danger"><div class="panel-heading"><h3 class="panel-title"><span class="fa fa-bus"></span> '+A["OFFLINE"][b]["BUS_NUM"]+'</h3></div><ul class="list-group"><li class="list-group-item"><strong>终端状态:</strong> <span class="text-danger">离线</span></li><li class="list-group-item"><strong>GPS最后更新时间:</strong> '+A["OFFLINE"][b]["UPDATE_TIME"]+"</li></ul></div></div>"}d("#online-list").html(x);d("#offline-list").html(s);NProgress.done();l=null});setTimeout(function(){if(l){l.abort();l=null;v()}},4000)}function u(){t="";l=d.post("./ajax/ajax.GetStop.php",{lineId:z},function(A){for(i=0;i<A.length;i++){t+='<a href="./index.php?mod=stopinfo&id='+A[i]["stop_id"]+'" class="list-group-item">';if(A[i]["have_bus"]){t+='<span class="badge"><span class="fa fa-bus"></span> '+A[i]["have_bus"]+"</span>"}t+='<span class="fa fa-map-marker"></span> '+A[i]["stop_name"]+"</a>"}d("#stop-list").html(t);d("#stop-refresh-btn").html('<span class="fa fa-refresh"></span> 刷新数据');d("#stop-refresh-btn").removeClass("disabled");d("#loader").fadeOut("fast");NProgress.done();l=null});setTimeout(function(){if(l){l.abort();l=null;d("#timeout").modal("show");d("#stop-refresh-btn").html('<span class="fa fa-refresh"></span> 刷新数据');d("#stop-refresh-btn").removeClass("disabled");d("#loader").fadeOut("fast");NProgress.done();d("#status").html("OFF");d("#auto-refresh-logo").removeClass("fa-spin");g=0;clearInterval(r);d("#auto-refresh-flag").prop("checked",false);d("#stop-auto-refresh-btn").removeClass("active")}},10000)}function n(){setTimeout(function(){if(d("#auto-refresh-flag").prop("checked")){d("#status").html("ON");d("#auto-refresh-logo").addClass("fa-spin");g=1}else{d("#status").html("OFF");d("#auto-refresh-logo").removeClass("fa-spin");g=0}if(g){r=setInterval(function(){d("#stop-refresh-btn").addClass("disabled");d("#stop-refresh-btn").html("刷新中...");d("#loader").fadeIn("fast");NProgress.start();u()},cacheTimeout)}else{clearInterval(r)}},5)}function e(){var A=d.get("./ajax/ajax.GetBusLocation.php",function(D){w.remove(j);w.remove(busOffline);var C=D.online;var B=D.offline;for(i=0;i<C.length;i++){marker=new AMap.Marker({icon:"./source/img/map-marker/marker-bus-online.png",position:C[i].position,title:C[i].title+"（终端在线）"});marker.setMap(w);j.push(marker)}for(k=0;k<B.length;k++){marker=new AMap.Marker({icon:"./source/img/map-marker/marker-bus-offline.png",position:B[k].position,title:B[k].title+"（终端离线）"});marker.setMap(w);busOffline.push(marker)}A=null});setTimeout(function(){if(A){A.abort();A=null;e()}},4000)}function q(){var A=d.get("./ajax/ajax.GetStopLocation.php",function(B){for(i=0;i<B.length;i++){marker=new AMap.Marker({icon:"./source/img/map-marker/marker-stop.png",position:B[i].position,title:B[i].title});marker.setMap(w)}A=null});setTimeout(function(){if(A){A.abort();A=null;q()}},4000)}function m(A){if(p){p.setMap(null)}var B=d.post("./ajax/ajax.GetPolyline.php",{id:A},function(C){p=new AMap.Polyline({path:C[0].poly_path,strokeColor:C[0].poly_color,strokeOpacity:0.8,strokeWeight:5,strokeStyle:"soild",strokeDasharray:[10,5]});p.setMap(w);B=null});setTimeout(function(){if(B){B.abort();B=null;m(A)}},4000)}d(document).ready(function(){c();d(document).pjax('a[data-pjax!="no-pjax"]',"#pjax",{fragment:"#pjax",timeout:60000});d(document).on("submit","#stopSearch",function(A){d.pjax.submit(A,"#pjax",{fragment:"#pjax",timeout:60000})});d(document).on("pjax:send",function(){clearInterval(y);clearInterval(r);clearInterval(o);l=null;d("#loader").fadeIn("fast");d("#navbar-collapse").collapse({toggle:false});d("#navbar-collapse").collapse("hide");NProgress.start()});d(document).on("pjax:complete",function(){d("body,html").animate({scrollTop:0},0);d("#loader").fadeOut("fast");NProgress.done();c()})})})(jQuery);